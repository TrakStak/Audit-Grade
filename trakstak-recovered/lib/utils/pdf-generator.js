import { jsPDF } from "jspdf";
import { supabase } from '../supabase.js'
import autoTable from "jspdf-autotable";

export async function generateAISummaryPDF() {
  const doc = new jsPDF();
  
  doc.setFontSize(16);
  doc.text("TrakStak â€“ AI Summary Report", 20, 20);

  const { data: { user } } = await supabase.auth.getUser();

  const { data: org } = await supabase
    .from("user_profiles")
    .select("organization_id")
    .eq("id", user.id)
    .single();

  const { data: orgInfo } = await supabase
    .from("organizations")
    .select("name")
    .eq("id", org.organization_id)
    .single();

  doc.setFontSize(12);
  doc.text(`Organization: ${orgInfo?.name || "Unknown Org"}`, 20, 30);
  doc.text(`Generated by: ${user.email}`, 20, 38);
  doc.text(`Date: ${new Date().toLocaleString()}`, 20, 46);

  const { data: suggestions } = await supabase
    .from("ai_suggestions")
    .select("*")
    .order("created_at", { ascending: false })
    .limit(20);

  autoTable(doc, {
    head: [["Date", "Suggestion"]],
    body: suggestions?.map((s) => [
      new Date(s.created_at).toLocaleDateString(),
      s.suggestion || s.suggestion_text || 'No suggestion',
    ]) || [],
    startY: 60,
  });

  doc.text("Auditor Signature: ____________________", 20, doc.lastAutoTable.finalY + 20);
  doc.save("AI_Summary_Report.pdf");
}
